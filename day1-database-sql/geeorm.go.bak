/*
geeorm.go æ˜¯æ•´ä¸ªæ¡†æ¶çš„å…¥å£ç‚¹å’Œæ ¸å¿ƒã€‚å®ƒè´Ÿè´£æ•°æ®åº“è¿æ¥çš„å»ºç«‹ã€æµ‹è¯•ã€ç®¡ç†å’Œå…³é—­ï¼Œå¹¶æä¾›äº†ä¸€ä¸ªæ–¹æ³•æ¥åˆ›å»ºç”¨äºå…·ä½“æ•°æ®åº“æ“ä½œçš„ Session å®ä¾‹ã€‚
    - åˆå§‹åŒ–æ•°æ®åº“è¿æ¥ï¼›
    - å°è£… *sql.DB ä¸º Engineï¼›
    - æä¾›åˆ›å»º Session çš„æ–¹æ³•ï¼›
    - ç®¡ç†æ•°æ®åº“è¿æ¥çš„ç”Ÿå‘½å‘¨æœŸï¼ˆæ‰“å¼€ã€å…³é—­ï¼‰ï¼›
*/

package geeorm

import (
	"database/sql"
	"geeorm/log"
	"geeorm/session"
)

// Go æ ‡å‡†æ•°æ®åº“é©±åŠ¨æ¥å£

// ä¼šè¯å°è£…æ¨¡å—

// Engine æ˜¯ ORM çš„æ ¸å¿ƒç»“æ„ä½“ï¼Œ
// ä¸»è¦èŒè´£æ˜¯ç®¡ç†æ•°æ®åº“è¿æ¥ï¼ˆdbï¼‰å¹¶åˆ›å»º Sessionã€‚
type Engine struct {
	/* ğŸ˜„
	   Engine.db å’Œ Session.db éƒ½æŒ‡å‘å†…å­˜ä¸­åŒä¸€ä¸ª *sql.DB å¯¹è±¡ã€‚
	   å®ƒä»¬çš„ä¼ é€’å…³ç³»æ˜¯è¿™æ ·çš„ï¼š
	     1. Engine ç»“æ„ä½“æŒæœ‰æ•´ä¸ªåº”ç”¨ç¨‹åºä¸­å”¯ä¸€çš„æ•°æ®åº“è¿æ¥æ±  (*sql.DB) çš„æŒ‡é’ˆã€‚è¿™ä¸ªè¿æ¥æ± æ˜¯åœ¨ NewEngine å‡½æ•°ä¸­åˆ›å»ºçš„ã€‚
	     2. å½“ä½ è°ƒç”¨ engine.NewSession() æ–¹æ³•æ—¶ï¼Œå®ƒå†…éƒ¨ä¼šæ‰§è¡Œ return session.New(engine.db)ã€‚
	     3. è¿™ä¸ªæ“ä½œå°† Engine æŒæœ‰çš„ *sql.DB æŒ‡é’ˆä½œä¸ºå‚æ•°ï¼Œä¼ é€’ç»™äº† session.New å‡½æ•°ã€‚
	     4. session.New å‡½æ•°å†å°†è¿™ä¸ªæŒ‡é’ˆèµ‹å€¼ç»™æ–°åˆ›å»ºçš„ Session å®ä¾‹çš„ db å­—æ®µã€‚
	*/
	db *sql.DB // è¿™ä¸ªå­—æ®µæŒæœ‰ä¸€ä¸ªæ•°æ®åº“è¿æ¥æ± çš„æŒ‡é’ˆï¼Œæ‰€æœ‰åç»­çš„æ•°æ®åº“æ“ä½œéƒ½å°†é€šè¿‡å®ƒè¿›è¡Œã€‚
}

// NewEngine ç”¨äºåˆå§‹åŒ–ä¸€ä¸ª Engine å®ä¾‹ï¼Œå»ºç«‹æ•°æ®åº“è¿æ¥ã€‚
//
// å‚æ•°ï¼š
//   - driver: é©±åŠ¨åç§°ï¼ˆå¦‚ "sqlite3", "mysql"ï¼‰
//   - source: æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼ˆå¦‚ SQLite æ–‡ä»¶è·¯å¾„ã€MySQL DSNï¼‰
//
// è¿”å›ï¼š
//   - e: åˆå§‹åŒ–åçš„ *Engine å®ä¾‹
//   - err: é”™è¯¯ä¿¡æ¯ï¼Œå¦‚æœè¿æ¥å¤±è´¥
func NewEngine(driver, source string) (e *Engine, err error) {
	// ç¬¬ä¸€æ­¥ï¼šæ‰“å¼€æ•°æ®åº“è¿æ¥ï¼ˆä¸ä»£è¡¨ç«‹åˆ»å»ºç«‹è¿æ¥ï¼‰
	db, err := sql.Open(driver, source)
	if err != nil {
		log.Error(err)
		return
	}

	// ç¬¬äºŒæ­¥ï¼šä½¿ç”¨ Ping() æ£€æŸ¥æ•°æ®åº“æ˜¯å¦çœŸçš„è¿é€š
	if err = db.Ping(); err != nil {
		log.Error(err)
		return
	}

	// ç¬¬ä¸‰æ­¥ï¼šåˆ›å»º Engine å®ä¾‹å¹¶è¿”å›
	e = &Engine{db: db}
	log.Info("Connect database success")
	return
}

// Closeæ–¹æ³• å…³é—­æ•°æ®åº“è¿æ¥ï¼Œé‡Šæ”¾èµ„æºã€‚
func (engine *Engine) Close() {
	if err := engine.db.Close(); err != nil {
		log.Error("Failed to close database") // æ•°æ®åº“å…³é—­å¤±è´¥
	}
	log.Info("Close database success") // æ—¥å¿—è¾“å‡ºï¼šæˆåŠŸå…³é—­
}

// NewSessionæ–¹æ³• åˆ›å»ºä¸€ä¸ªæ–°çš„ Session å®ä¾‹ï¼Œä¾› ORM æ“ä½œä½¿ç”¨ã€‚
// æ¯æ¬¡è°ƒç”¨éƒ½å°†è¿”å›ä¸€ä¸ªå…¨æ–°çš„ Session å®ä¾‹ï¼Œå®ƒä¸ Engine å…±äº«åŒä¸€ä¸ªæ•°æ®åº“è¿æ¥æ± ï¼Œä½†æ‹¥æœ‰ç‹¬ç«‹çš„ SQL æ„å»ºçŠ¶æ€
// Session å†…éƒ¨æŒæœ‰ dbï¼Œå¯ä»¥æ„å»ºå¹¶æ‰§è¡Œ SQL è¯­å¥ã€‚
func (engine *Engine) NewSession() *session.Session {
	return session.New(engine.db)
}

/* ç¤ºä¾‹ç”¨æ³•ï¼š
   engine, err := geeorm.NewEngine("sqlite3", "gee.db")
   if err != nil {
       panic("æ•°æ®åº“è¿æ¥å¤±è´¥")
   }
   defer engine.Close()

   session := engine.NewSession()
   session.Raw("CREATE TABLE User(Name text, Age integer)").Exec()
*/
